<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω S·∫£n ph·∫©m - Admin</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/admin/css/admin.css">
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <span class="logo-icon"><img src="/images/logo/roblox-app-icon-hd-removebg-preview.png" alt="Logo" style="height: 35px; vertical-align: middle;"></span>
                <span>GameShop Admin</span>
            </div>
            
            <nav class="admin-nav">
                <a href="/admin/dashboard.html" class="nav-item">
                    <span>üìä</span> Dashboard
                </a>
                <a href="/admin/orders.html" class="nav-item">
                    <span>üõí</span> ƒê∆°n h√†ng
                </a>
                <a href="/admin/products.html" class="nav-item active">
                    <span>üõçÔ∏è</span> S·∫£n ph·∫©m
                </a>                <a href="/admin/categories.html" class="nav-item">
                    <span>üìÅ</span> Danh m·ª•c
                </a>                <a href="#" onclick="logout()" class="nav-item">
                    <span>üö™</span> ƒêƒÉng xu·∫•t
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-content">
            <header class="admin-header">
                <h1>Qu·∫£n l√Ω S·∫£n ph·∫©m</h1>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-success" onclick="exportToExcel()" style="background: linear-gradient(135deg, #11998e, #38ef7d); border: none; padding: 12px 24px; font-size: 16px;">üìä Xu·∫•t Excel</button>
                    <button class="btn btn-primary" onclick="showAddProduct()" style="padding: 12px 24px; font-size: 16px;">‚ûï Th√™m s·∫£n ph·∫©m</button>
                </div>
            </header>

            <!-- Filter Section -->
            <div class="dashboard-section">
                <div class="filter-bar">
                    <input 
                        type="text" 
                        id="search-product" 
                        class="form-select" 
                        placeholder="üîç T√¨m t√™n s·∫£n ph·∫©m..."
                        style="min-width: 250px;"
                        oninput="loadProducts()"
                    >
                    
                    <select id="filter-game" class="form-select" onchange="loadProducts()">
                        <option value="">T·∫•t c·∫£ game</option>
                    </select>

                    <select id="filter-active" class="form-select" onchange="loadProducts()">
                        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                        <option value="1">ƒêang b√°n</option>
                        <option value="0">Ng·ª´ng b√°n</option>
                    </select>

                    <button class="btn btn-secondary" onclick="resetFilters()">‚úñÔ∏è X√≥a b·ªô l·ªçc</button>
                </div>

                <!-- Products Table -->
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 70px; text-align: center;">ID</th>
                            <th style="width: 90px; text-align: center;">H√åNH ·∫¢NH</th>
                            <th style="min-width: 250px;">T√äN S·∫¢N PH·∫®M</th>
                            <th style="width: 170px; text-align: left;">GAME</th>
                            <th style="width: 120px; text-align: right;">GI√Å NH·∫¨P</th>
                            <th style="width: 120px; text-align: right;">GI√Å B√ÅN</th>
                            <th style="width: 130px; text-align: center;">TR·∫†NG TH√ÅI</th>
                            <th style="width: 130px; text-align: center;">THAO T√ÅC</th>
                        </tr>
                    </thead>
                    <tbody id="products-table">
                        <tr><td colspan="8" style="text-align: center;">ƒêang t·∫£i...</td></tr>
                    </tbody>
                </table>

                <div class="pagination" id="products-pagination" style="margin-top: 20px; text-align: center;">
                    <!-- Pagination will be rendered here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="product-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="modal-title">Th√™m s·∫£n ph·∫©m m·ªõi</h2>
                <button class="close-btn" onclick="closeModal()">‚úñ</button>
            </div>
            <form id="product-form" onsubmit="handleSubmit(event)">
                <input type="hidden" id="product-id">
                
                <div class="form-group">
                    <label>Game <span style="color: red;">*</span></label>
                    <select id="form-game" class="form-control" required onchange="loadCategories()">
                        <option value="">-- Ch·ªçn game --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Danh m·ª•c <span style="color: red;">*</span></label>
                    <select id="form-category" class="form-control" required>
                        <option value="">-- Ch·ªçn game tr∆∞·ªõc --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>T√™n s·∫£n ph·∫©m <span style="color: red;">*</span></label>
                    <input type="text" id="form-name" class="form-control" required>
                </div>

                <div class="form-group">
                    <label>M√¥ t·∫£</label>
                    <textarea id="form-description" class="form-control" rows="4"></textarea>
                </div>

                <div class="form-group">
                    <label>Gi√° b√°n <span style="color: red;">*</span></label>
                    <div class="price-input-wrapper">
                        <input type="number" id="form-price" class="form-control price-input" required min="0" step="1000" placeholder="0">
                        <span class="price-currency">VNƒê</span>
                    </div>
                    <small class="form-text" style="color: #6c757d; margin-top: 5px; display: block;">Nh·∫≠p gi√° theo ƒë∆°n v·ªã VNƒê (v√≠ d·ª•: 50000)</small>
                </div>

                <div class="form-group">
                    <label>Gi√° nh·∫≠p <span style="color: red;">*</span></label>
                    <div class="price-input-wrapper">
                        <input type="number" id="form-cost-price" class="form-control price-input" required min="0" step="1000" placeholder="0">
                        <span class="price-currency">VNƒê</span>
                    </div>
                    <small class="form-text" style="color: #28a745; margin-top: 5px; display: block;">üí° Gi√° nh·∫≠p t·ª´ nh√† cung c·∫•p (ƒë·ªÉ t√≠nh l·ª£i nhu·∫≠n)</small>
                </div>

                <div class="form-group">
                    <label>H√¨nh ·∫£nh s·∫£n ph·∫©m</label>
                    <input type="file" id="form-image-file" class="form-control" accept="image/*" onchange="handleImageUpload(event)">
                    <input type="hidden" id="form-image" class="form-control">
                    <small class="form-text" style="color: #6c757d; margin-top: 5px; display: block;">üì∑ Ch·ªçn ·∫£nh t·ª´ m√°y t√≠nh (t·ªëi ƒëa 5MB, ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën thay ƒë·ªïi)</small>
                    
                    <!-- Image Preview -->
                    <div id="image-preview" style="margin-top: 15px; display: none;">
                        <img id="preview-img" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid #ddd;">
                        <div style="margin-top: 10px;">
                            <span id="upload-status" style="color: #28a745; font-weight: 500;"></span>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="removeImage()" style="margin-left: 10px; padding: 4px 12px;">‚ùå X√≥a</button>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>T·ªìn kho</label>
                        <input type="number" id="form-stock" class="form-control" value="999" min="0">
                    </div>

                    <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 28px;">
                        <label style="margin: 0;">
                            <input type="checkbox" id="form-featured"> S·∫£n ph·∫©m n·ªïi b·∫≠t
                        </label>
                        <label style="margin: 0;">
                            <input type="checkbox" id="form-active" checked> ƒêang b√°n
                        </label>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">üíæ L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script src="/admin/js/admin.js"></script>
    <script>
        let allGames = [];
        let allCategories = [];
        let currentProducts = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        async function loadGamesAndCategories() {
            try {
                const [gamesResult, categoriesResult] = await Promise.all([
                    API.get('/api/games'),
                    API.get('/api/categories')
                ]);

                if (gamesResult.success) {
                    allGames = gamesResult.data;
                    const gameSelects = ['filter-game', 'form-game'];
                    gameSelects.forEach(selectId => {
                        const select = document.getElementById(selectId);
                        if (selectId === 'filter-game') {
                            select.innerHTML = '<option value="">T·∫•t c·∫£ game</option>';
                        } else {
                            select.innerHTML = '<option value="">-- Ch·ªçn game --</option>';
                        }
                        allGames.forEach(game => {
                            select.innerHTML += `<option value="${game.game_id}">${game.name}</option>`;
                        });
                    });
                }

                if (categoriesResult.success) {
                    allCategories = categoriesResult.data;
                }
            } catch (error) {
                console.error('Error loading games/categories:', error);
            }
        }

        function loadCategories() {
            const gameId = document.getElementById('form-game').value;
            const categorySelect = document.getElementById('form-category');
            
            if (!gameId) {
                categorySelect.innerHTML = '<option value="">-- Ch·ªçn game tr∆∞·ªõc --</option>';
                return;
            }

            const categories = allCategories.filter(cat => cat.game_id == gameId);
            categorySelect.innerHTML = '<option value="">-- Ch·ªçn danh m·ª•c --</option>';
            categories.forEach(cat => {
                categorySelect.innerHTML += `<option value="${cat.category_id}">${cat.name}</option>`;
            });
        }

        function handleSearchEnter(event) {
            if (event.key === 'Enter') {
                loadProducts();
            }
        }

        async function loadProducts() {
            const auth = checkAdminAuth();
            if (!auth) return;

            const searchTerm = document.getElementById('search-product').value.trim().toLowerCase();
            const gameId = document.getElementById('filter-game').value;
            const isActive = document.getElementById('filter-active').value;

            try {
                const result = await API.get('/api/products?limit=1000');
                
                if (!result.success || !result.data) {
                    document.getElementById('products-table').innerHTML = 
                        '<tr><td colspan="7" style="text-align: center;">Kh√¥ng c√≥ s·∫£n ph·∫©m</td></tr>';
                    return;
                }

                let products = result.data;

                // S·∫Øp x·∫øp theo product_id gi·∫£m d·∫ßn (m·ªõi nh·∫•t tr√™n c√πng)
                products.sort((a, b) => b.product_id - a.product_id);

                // L·ªçc theo t√™n
                if (searchTerm) {
                    products = products.filter(p => 
                        p.name.toLowerCase().includes(searchTerm)
                    );
                }

                // L·ªçc theo game
                if (gameId) {
                    products = products.filter(p => p.game_id == gameId);
                }

                // L·ªçc theo tr·∫°ng th√°i
                if (isActive !== '') {
                    products = products.filter(p => p.is_active == isActive);
                }

                currentProducts = products;
                currentPage = 1;

                if (products.length === 0) {
                    document.getElementById('products-table').innerHTML = 
                        '<tr><td colspan="7" style="text-align: center;">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</td></tr>';
                    document.getElementById('products-pagination').innerHTML = '';
                    return;
                }

                displayProducts(products);
            } catch (error) {
                console.error('Error loading products:', error);
                showNotification('L·ªói khi t·∫£i s·∫£n ph·∫©m', 'error');
            }
        }

        function displayProducts(products) {
            const totalPages = Math.ceil(products.length / itemsPerPage);
            
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }
            if (currentPage < 1) {
                currentPage = 1;
            }

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedProducts = products.slice(startIndex, endIndex);

            const tbody = document.getElementById('products-table');
            tbody.innerHTML = paginatedProducts.map(product => `
                <tr>
                    <td style="text-align: center; padding: 12px 8px;"><strong style="color: #667eea;">#${product.product_id || 'N/A'}</strong></td>
                    <td style="text-align: center; padding: 8px;">
                        <img src="${product.image_url || '/images/logo/roblox-app-icon-hd-removebg-preview.png'}" 
                             alt="${product.name}" 
                             onerror="this.src='/images/logo/roblox-app-icon-hd-removebg-preview.png'"
                             style="width: 55px; height: 55px; object-fit: cover; border-radius: 8px; border: 2px solid #e0e0e0; display: block; margin: 0 auto;">
                    </td>
                    <td style="padding: 12px 15px;">
                        <strong style="color: #333; font-size: 14px;">${product.name}</strong>
                        <br>
                        <small style="color: #999; font-size: 12px;">${product.unit ? product.price + ' ' + product.unit : ''}</small>
                    </td>
                    <td style="padding: 12px 15px; color: #555;">${product.game_name || 'N/A'}</td>
                    <td style="text-align: right; padding: 12px 15px;">
                        <strong style="color: #ff6b6b; font-size: 14px;">${formatCurrency(product.cost_price || 0)}</strong>
                    </td>
                    <td style="text-align: right; padding: 12px 15px;">
                        <strong style="color: #28a745; font-size: 14px;">${formatCurrency(product.price)}</strong>
                        <br>
                        <small style="color: #667eea; font-size: 11px; font-weight: 600;">LN: ${formatCurrency((product.price - (product.cost_price || 0)))}</small>
                    </td>
                    <td style="text-align: center; padding: 12px 8px;">
                        <span class="badge ${product.is_active ? 'badge-success' : 'badge-secondary'}">
                            ${product.is_active ? '‚úì ƒêang b√°n' : '‚úï Ng·ª´ng b√°n'}
                        </span>
                    </td>
                    <td style="text-align: center; padding: 12px 8px;">
                        <button class="btn-small btn-primary" onclick="editProduct(${product.product_id})" title="Ch·ªânh s·ª≠a">‚úèÔ∏è</button>
                        <button class="btn-small btn-danger" onclick="deleteProduct(${product.product_id}, '${product.name}')" title="X√≥a">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');

            renderProductsPagination(products.length);
        }

        function renderProductsPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);

            let paginationHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                    <button class="btn btn-secondary btn-sm" onclick="changeProductPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                        ‚Üê Trang tr∆∞·ªõc
                    </button>
                    <span style="font-size: 14px;">
                        Hi·ªÉn th·ªã ${startItem}-${endItem} trong t·ªïng ${totalItems} s·∫£n ph·∫©m | Trang ${currentPage}/${totalPages}
                    </span>
                    <button class="btn btn-secondary btn-sm" onclick="changeProductPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                        Trang sau ‚Üí
                    </button>
                </div>
            `;

            document.getElementById('products-pagination').innerHTML = paginationHTML;
        }

        function changeProductPage(page) {
            const totalPages = Math.ceil(currentProducts.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            displayProducts(currentProducts);
        }

        function resetFilters() {
            document.getElementById('search-product').value = '';
            document.getElementById('filter-game').value = '';
            document.getElementById('filter-active').value = '';
            currentPage = 1;
            loadProducts();
        }

        function showAddProduct() {
            document.getElementById('modal-title').textContent = 'Th√™m s·∫£n ph·∫©m m·ªõi';
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('form-category').innerHTML = '<option value="">-- Ch·ªçn game tr∆∞·ªõc --</option>';
            document.getElementById('form-active').checked = true;
            document.getElementById('form-image').value = '';
            document.getElementById('image-preview').style.display = 'none';
            document.getElementById('product-modal').style.display = 'flex';
        }

        // Upload image when file is selected
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                showNotification('Ch·ªâ ch·∫•p nh·∫≠n file ·∫£nh (JPG, PNG, GIF, WEBP)', 'error');
                event.target.value = '';
                return;
            }

            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('K√≠ch th∆∞·ªõc file kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB', 'error');
                event.target.value = '';
                return;
            }

            // Show preview immediately
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('image-preview').style.display = 'block';
                document.getElementById('upload-status').textContent = '‚è≥ ƒêang upload...';
            };
            reader.readAsDataURL(file);

            // Upload to server
            try {
                const formData = new FormData();
                formData.append('image', file);

                console.log('Uploading image to /api/upload-image...');
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    body: formData
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Upload result:', result);

                if (result.success) {
                    document.getElementById('form-image').value = result.imageUrl;
                    document.getElementById('upload-status').textContent = '‚úÖ Upload th√†nh c√¥ng!';
                    showNotification('Upload ·∫£nh th√†nh c√¥ng', 'success');
                    console.log('Image URL saved:', result.imageUrl);
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showNotification('L·ªói khi upload ·∫£nh: ' + error.message, 'error');
                document.getElementById('image-preview').style.display = 'none';
                event.target.value = '';
            }
        }

        // Remove uploaded image
        function removeImage() {
            document.getElementById('form-image-file').value = '';
            document.getElementById('form-image').value = '';
            document.getElementById('image-preview').style.display = 'none';
        }

        function editProduct(productId) {
            const product = currentProducts.find(p => p.product_id === productId);
            if (!product) return;

            document.getElementById('modal-title').textContent = 'Ch·ªânh s·ª≠a s·∫£n ph·∫©m';
            document.getElementById('product-id').value = product.product_id;
            document.getElementById('form-game').value = product.game_id;
            
            // Load categories for selected game
            loadCategories();
            setTimeout(() => {
                document.getElementById('form-category').value = product.category_id;
            }, 100);

            document.getElementById('form-name').value = product.name;
            document.getElementById('form-description').value = product.description || '';
            document.getElementById('form-price').value = product.price;
            document.getElementById('form-cost-price').value = product.cost_price || 0;
            document.getElementById('form-image').value = product.image_url || '';
            document.getElementById('form-stock').value = product.stock_quantity;
            document.getElementById('form-featured').checked = product.is_featured;
            document.getElementById('form-active').checked = product.is_active;

            // Show existing image preview if available
            if (product.image_url) {
                document.getElementById('preview-img').src = product.image_url;
                document.getElementById('image-preview').style.display = 'block';
                document.getElementById('upload-status').textContent = '‚úÖ ·∫¢nh hi·ªán t·∫°i';
            } else {
                document.getElementById('image-preview').style.display = 'none';
            }

            document.getElementById('product-modal').style.display = 'flex';
        }

        async function handleSubmit(event) {
            event.preventDefault();
            const auth = checkAdminAuth();
            if (!auth) return;

            const productId = document.getElementById('product-id').value;
            const productData = {
                game_id: document.getElementById('form-game').value,
                category_id: document.getElementById('form-category').value,
                name: document.getElementById('form-name').value,
                description: document.getElementById('form-description').value,
                price: parseFloat(document.getElementById('form-price').value),
                cost_price: parseFloat(document.getElementById('form-cost-price').value),
                image_url: document.getElementById('form-image').value || null,
                stock_quantity: parseInt(document.getElementById('form-stock').value),
                is_featured: document.getElementById('form-featured').checked ? 1 : 0,
                is_active: document.getElementById('form-active').checked ? 1 : 0
            };

            try {
                let result;
                if (productId) {
                    result = await AdminAPI.updateProduct(productId, productData);
                } else {
                    result = await AdminAPI.createProduct(productData);
                }

                if (result.success) {
                    showNotification(productId ? 'C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng' : 'Th√™m s·∫£n ph·∫©m th√†nh c√¥ng', 'success');
                    closeModal();
                    // Reset filters v√† reload
                    document.getElementById('search-product').value = '';
                    document.getElementById('filter-game').value = '';
                    document.getElementById('filter-active').value = '';
                    setTimeout(() => {
                        loadProducts();
                    }, 200);
                } else {
                    showNotification(result.message || 'C√≥ l·ªói x·∫£y ra', 'error');
                }
            } catch (error) {
                console.error('Submit error:', error);
                showNotification('L·ªói khi l∆∞u s·∫£n ph·∫©m', 'error');
            }
        }

        async function deleteProduct(productId, productName) {
            const confirmed = await showConfirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m "${productName}"?`, 'X√≥a s·∫£n ph·∫©m');
            if (!confirmed) return;

            const auth = checkAdminAuth();
            if (!auth) return;

            try {
                const result = await AdminAPI.deleteProduct(productId);
                if (result.success) {
                    showNotification('X√≥a s·∫£n ph·∫©m th√†nh c√¥ng', 'success');
                    loadProducts();
                } else {
                    showNotification(result.message || 'C√≥ l·ªói x·∫£y ra', 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showNotification('L·ªói khi x√≥a s·∫£n ph·∫©m', 'error');
            }
        }

        function closeModal() {
            document.getElementById('product-modal').style.display = 'none';
        }

        async function logout() {
            const confirmed = await showConfirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?', 'X√°c nh·∫≠n ƒëƒÉng xu·∫•t');
            if (confirmed) {
                localStorage.removeItem('admin_token');
                localStorage.removeItem('admin_user');
                window.location.href = '/admin/login.html';
            }
        }

        // Export to Excel function
        async function exportToExcel() {
            try {
                showNotification('ƒêang chu·∫©n b·ªã file Excel...', 'info');
                
                // L·∫•y t·∫•t c·∫£ s·∫£n ph·∫©m
                const result = await AdminAPI.getAllProducts();
                
                if (!result.success || !result.data || result.data.length === 0) {
                    showNotification('Kh√¥ng c√≥ s·∫£n ph·∫©m ƒë·ªÉ xu·∫•t', 'error');
                    return;
                }

                const products = result.data;
                
                // T·∫°o m·∫£ng d·ªØ li·ªáu cho Excel
                const excelData = products.map(product => ({
                    'ID': product.product_id,
                    'T√™n s·∫£n ph·∫©m': product.name,
                    'Game': product.game_name || 'N/A',
                    'Danh m·ª•c': product.category_name || 'N/A',
                    'Gi√° nh·∫≠p (VNƒê)': product.cost_price || 0,
                    'Gi√° b√°n (VNƒê)': product.price,
                    'L·ª£i nhu·∫≠n/sp (VNƒê)': (product.price - (product.cost_price || 0)),
                    'T·ªìn kho': product.stock_quantity || 0,
                    'ƒê√£ b√°n': product.sold_count || 0,
                    'T·ªïng l·ª£i nhu·∫≠n (VNƒê)': (product.price - (product.cost_price || 0)) * (product.sold_count || 0),
                    'ƒê∆°n v·ªã': product.unit || 'VNƒê',
                    'N·ªïi b·∫≠t': product.is_featured ? 'C√≥' : 'Kh√¥ng',
                    'Tr·∫°ng th√°i': product.is_active ? 'ƒêang b√°n' : 'Ng·ª´ng b√°n',
                    'Ng√†y t·∫°o': new Date(product.created_at).toLocaleString('vi-VN'),
                    'M√¥ t·∫£': product.description || ''
                }));

                // T·∫°o workbook v√† worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);

                // ƒê·ªãnh d·∫°ng c·ªôt
                const colWidths = [
                    { wch: 8 },   // ID
                    { wch: 35 },  // T√™n s·∫£n ph·∫©m
                    { wch: 20 },  // Game
                    { wch: 20 },  // Danh m·ª•c
                    { wch: 15 },  // Gi√° nh·∫≠p
                    { wch: 15 },  // Gi√° b√°n
                    { wch: 18 },  // L·ª£i nhu·∫≠n/sp
                    { wch: 10 },  // T·ªìn kho
                    { wch: 10 },  // ƒê√£ b√°n
                    { wch: 18 },  // T·ªïng l·ª£i nhu·∫≠n
                    { wch: 10 },  // ƒê∆°n v·ªã
                    { wch: 10 },  // N·ªïi b·∫≠t
                    { wch: 12 },  // Tr·∫°ng th√°i
                    { wch: 18 },  // Ng√†y t·∫°o
                    { wch: 50 }   // M√¥ t·∫£
                ];
                ws['!cols'] = colWidths;

                // Th√™m worksheet v√†o workbook
                XLSX.utils.book_append_sheet(wb, ws, 'S·∫£n ph·∫©m');

                // T·∫°o t√™n file v·ªõi timestamp
                const timestamp = new Date().toISOString().slice(0, 10);
                const filename = `SanPham_${timestamp}.xlsx`;

                // Download file
                XLSX.writeFile(wb, filename);
                
                showNotification(`‚úÖ ƒê√£ xu·∫•t ${excelData.length} s·∫£n ph·∫©m ra file ${filename}`, 'success');
            } catch (error) {
                console.error('Export Excel error:', error);
                showNotification('L·ªói khi xu·∫•t Excel: ' + error.message, 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const auth = checkAdminAuth();
            if (auth) {
                loadGamesAndCategories();
                loadProducts();
            }
        });

        // Modal styling
        const style = document.createElement('style');
        style.textContent = `
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 1000;
                align-items: center;
                justify-content: center;
            }
            .modal-content {
                background: white;
                border-radius: 8px;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }
            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 20px;
                border-bottom: 1px solid #e0e0e0;
            }
            .modal-header h2 {
                margin: 0;
            }
            .close-btn {
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #666;
            }
            .close-btn:hover {
                color: #000;
            }
            #product-form {
                padding: 20px;
            }
            .form-group {
                margin-bottom: 15px;
            }
            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: 500;
            }
            .form-control {
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
            }
            .form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            .modal-footer {
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                padding-top: 15px;
                border-top: 1px solid #e0e0e0;
            }
            .btn-small {
                padding: 6px 12px;
                font-size: 16px;
                margin: 0 4px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.2s;
            }
            .btn-small:hover {
                transform: translateY(-2px);
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            }
            .btn-danger {
                background: #dc3545;
                color: white;
            }
            .btn-danger:hover {
                background: #c82333;
            }
            .badge {
                padding: 6px 12px;
                border-radius: 6px;
                font-size: 13px;
                font-weight: 600;
                display: inline-block;
            }
            .badge-success {
                background: #28a745;
                color: white;
            }
            .badge-secondary {
                background: #6c757d;
                color: white;
            }
            .data-table {
                width: 100%;
                border-collapse: collapse;
                background: white;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            .data-table thead {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            .data-table thead th {
                padding: 14px 10px;
                font-weight: 600;
                color: white;
                font-size: 12px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                border-right: 1px solid rgba(255,255,255,0.1);
            }
            .data-table thead th:last-child {
                border-right: none;
            }
            .data-table tbody tr {
                border-bottom: 1px solid #f0f0f0;
                transition: background 0.2s;
            }
            .data-table tbody tr:hover {
                background: #f8f9ff;
            }
            .data-table tbody td {
                vertical-align: middle;
                border-right: 1px solid #f5f5f5;
            }
            .data-table tbody td:last-child {
                border-right: none;
            }
        `;
        document.head.appendChild(style);
    </script>

    <script src="/admin/js/notifications.js"></script>
</body>
</html>
