<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω ƒë∆°n h√†ng - Admin</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/admin/css/admin.css">
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="admin-layout">
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <span class="logo-icon"><img src="/images/logo/roblox-app-icon-hd-removebg-preview.png" alt="Logo" style="height: 35px; vertical-align: middle;"></span>
                <span>GameShop Admin</span>
            </div>
            
            <nav class="admin-nav">
                <a href="/admin/dashboard.html" class="nav-item">
                    <span>üìä</span> Dashboard
                </a>
                <a href="/admin/orders.html" class="nav-item active">
                    <span>üõí</span> ƒê∆°n h√†ng
                </a>
                <a href="/admin/products.html" class="nav-item">
                    <span>üõçÔ∏è</span> S·∫£n ph·∫©m
                </a>                <a href="/admin/categories.html" class="nav-item">
                    <span>üìÅ</span> Danh m·ª•c
                </a>                <a href="#" onclick="logout()" class="nav-item">
                    <span>üö™</span> ƒêƒÉng xu·∫•t
                </a>
            </nav>
        </aside>

        <main class="admin-content">
            <header class="admin-header">
                <h1>Qu·∫£n l√Ω ƒë∆°n h√†ng</h1>
            </header>

            <div class="dashboard-section">
                <div class="filter-bar">
                    <input 
                        type="text" 
                        id="search-order-code" 
                        class="form-select" 
                        placeholder="üîç T√¨m theo m√£ ƒë∆°n h√†ng..."
                        style="min-width: 250px;"
                        oninput="loadOrders()"
                    >
                    
                    <select id="filter-status" class="form-select" onchange="loadOrders()">
                        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                        <option value="pending">Ch·ªù x·ª≠ l√Ω</option>
                        <option value="completed">Ho√†n th√†nh</option>
                        <option value="cancelled">ƒê√£ h·ªßy</option>
                    </select>

                    <select id="filter-payment-status" class="form-select" onchange="loadOrders()">
                        <option value="">T·∫•t c·∫£ thanh to√°n</option>
                        <option value="unpaid">Ch∆∞a thanh to√°n</option>
                        <option value="paid">ƒê√£ thanh to√°n</option>
                        <option value="refunded">ƒê√£ ho√†n ti·ªÅn</option>
                    </select>

                    <button class="btn btn-secondary" onclick="resetFilters()">‚úñÔ∏è X√≥a b·ªô l·ªçc</button>
                    <button class="btn btn-success" onclick="exportToExcel()" style="background: linear-gradient(135deg, #11998e, #38ef7d); border: none;">üìä Xu·∫•t Excel</button>
                </div>

                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>M√£ ƒë∆°n</th>
                                <th>Kh√°ch h√†ng</th>
                                <th>Li√™n h·ªá</th>
                                <th>T·ªïng ti·ªÅn</th>
                                <th>Thanh to√°n</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Ng√†y ƒë·∫∑t</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table">
                            <tr>
                                <td colspan="8" style="text-align: center;">ƒêang t·∫£i...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="pagination" id="pagination" style="margin-top: 20px; text-align: center;">
                    <!-- Pagination will be rendered here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Order Detail Modal -->
    <div id="order-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div id="order-detail-content"></div>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script src="/admin/js/admin.js"></script>
    <script>
        function handleSearchEnter(event) {
            if (event.key === 'Enter') {
                loadOrders();
            }
        }

        async function loadOrders() {
            console.log('=== LOAD ORDERS START ===');
            const auth = checkAdminAuth();
            console.log('Auth check result:', auth);
            
            if (!auth) {
                console.error('Authentication failed!');
                return;
            }

            const searchCode = document.getElementById('search-order-code').value.trim();
            const status = document.getElementById('filter-status').value;
            const paymentStatus = document.getElementById('filter-payment-status').value;

            try {
                console.log('Loading orders with filters:', { status, paymentStatus, searchCode });
                console.log('Calling AdminAPI.getAllOrders...');
                
                const result = await AdminAPI.getAllOrders({ status, limit: 1000 });
                console.log('API result:', result);
                
                if (!result) {
                    console.error('No result from API!');
                    document.getElementById('orders-table').innerHTML = `
                        <tr><td colspan="8" style="text-align: center; color: red;">L·ªói: Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ server</td></tr>
                    `;
                    return;
                }
                
                if (!result.success) {
                    console.error('API returned error:', result.error || result.message);
                    document.getElementById('orders-table').innerHTML = `
                        <tr><td colspan="8" style="text-align: center; color: red;">L·ªói: ${result.error || result.message || 'Unknown error'}</td></tr>
                    `;
                    return;
                }
                
                if (!result.data || result.data.length === 0) {
                    console.warn('No orders found in database');
                    document.getElementById('orders-table').innerHTML = `
                        <tr><td colspan="8" style="text-align: center;">Kh√¥ng c√≥ ƒë∆°n h√†ng</td></tr>
                    `;
                    document.getElementById('pagination').innerHTML = '';
                    return;
                }
                
                console.log(`Found ${result.data.length} orders`);

                let orders = result.data;

                // L·ªçc theo thanh to√°n
                if (paymentStatus) {
                    orders = orders.filter(order => order.payment_status === paymentStatus);
                }

                // L·ªçc theo m√£ ƒë∆°n h√†ng n·∫øu c√≥
                if (searchCode) {
                    orders = orders.filter(order => 
                        order.order_code.toLowerCase().includes(searchCode.toLowerCase())
                    );
                }

                // Reset to page 1 when filters change
                currentPage = 1;

                if (orders.length === 0) {
                    document.getElementById('orders-table').innerHTML = `
                        <tr><td colspan="8" style="text-align: center;">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng</td></tr>
                    `;
                    document.getElementById('pagination').innerHTML = '';
                    return;
                }

                displayOrders(orders);
            } catch (error) {
                console.error('Load orders error:', error);
                showNotification('L·ªói khi t·∫£i ƒë∆°n h√†ng', 'error');
            }
        }

        let currentPage = 1;
        const itemsPerPage = 5;
        let allOrders = [];
        let lastOrderCount = 0;
        let isFirstLoad = true;
        let autoRefreshInterval = null;

        // Request desktop notification permission
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    console.log('Notification permission:', permission);
                    if (permission === 'granted') {
                        showNotification('‚úÖ Th√¥ng b√°o ƒë√£ ƒë∆∞·ª£c b·∫≠t. B·∫°n s·∫Ω nh·∫≠n th√¥ng b√°o khi c√≥ ƒë∆°n h√†ng m·ªõi!', 'success');
                    }
                });
            }
        }

        // Check for new orders
        async function checkNewOrders() {
            const auth = checkAdminAuth();
            if (!auth) return;

            try {
                const result = await AdminAPI.getAllOrders({ limit: 1000 });
                
                if (result.success && result.data) {
                    const currentOrderCount = result.data.length;
                    
                    // N·∫øu kh√¥ng ph·∫£i l·∫ßn ƒë·∫ßu ti√™n v√† c√≥ ƒë∆°n h√†ng m·ªõi
                    if (!isFirstLoad && currentOrderCount > lastOrderCount) {
                        const newOrdersCount = currentOrderCount - lastOrderCount;
                        const latestOrders = result.data.slice(0, newOrdersCount);
                        
                        // Hi·ªÉn th·ªã notification
                        showNotification(`üîî C√≥ ${newOrdersCount} ƒë∆°n h√†ng m·ªõi!`, 'success');
                        
                        // Desktop notification
                        showDesktopNotification(newOrdersCount, latestOrders[0]);
                        
                        // Ph√°t √¢m thanh th√¥ng b√°o
                        playNotificationSound();
                        
                        // Visual alert - flash page title
                        flashPageTitle(newOrdersCount);
                        
                        // T·ª± ƒë·ªông load l·∫°i danh s√°ch
                        loadOrders();
                    }
                    
                    lastOrderCount = currentOrderCount;
                    isFirstLoad = false;
                }
            } catch (error) {
                console.error('Check new orders error:', error);
            }
        }

        // Show desktop notification
        function showDesktopNotification(count, latestOrder) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification('üõí ƒê∆°n h√†ng m·ªõi!', {
                    body: `C√≥ ${count} ƒë∆°n h√†ng m·ªõi.\nM√£: ${latestOrder.order_code}\nKh√°ch: ${latestOrder.customer_name}\nT·ªïng: ${formatCurrency(latestOrder.total_amount)}`,
                    icon: '/images/logo/roblox-app-icon-hd-removebg-preview.png',
                    badge: '/images/logo/roblox-app-icon-hd-removebg-preview.png',
                    tag: 'new-order',
                    requireInteraction: true
                });
                
                notification.onclick = function() {
                    window.focus();
                    notification.close();
                };
                
                // Auto close after 10 seconds
                setTimeout(() => notification.close(), 10000);
            }
        }

        // Flash page title
        let titleFlashInterval = null;
        function flashPageTitle(count) {
            const originalTitle = document.title;
            let isFlash = true;
            
            // Clear any existing interval
            if (titleFlashInterval) {
                clearInterval(titleFlashInterval);
            }
            
            titleFlashInterval = setInterval(() => {
                document.title = isFlash ? `(üîî ${count}) ƒê∆°n h√†ng m·ªõi!` : originalTitle;
                isFlash = !isFlash;
            }, 1000);
            
            // Stop flashing after 10 seconds
            setTimeout(() => {
                if (titleFlashInterval) {
                    clearInterval(titleFlashInterval);
                    titleFlashInterval = null;
                }
                document.title = originalTitle;
            }, 10000);
        }

        // Play notification sound
        function playNotificationSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE');
                audio.volume = 0.3;
                audio.play().catch(e => console.log('Audio play failed:', e));
            } catch (e) {
                console.log('Could not play notification sound:', e);
            }
        }

        // Start auto-refresh
        function startAutoRefresh() {
            // Clear any existing interval
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // Check every 30 seconds
            autoRefreshInterval = setInterval(checkNewOrders, 30000);
        }

        // Stop auto-refresh
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        function displayOrders(orders) {
            allOrders = orders;
            
            // Update last order count
            if (orders.length > 0) {
                lastOrderCount = orders.length;
            }
            
            const totalPages = Math.ceil(orders.length / itemsPerPage);
            
            // Ensure currentPage is within bounds
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }
            if (currentPage < 1) {
                currentPage = 1;
            }

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedOrders = orders.slice(startIndex, endIndex);

            if (paginatedOrders.length === 0) {
                document.getElementById('orders-table').innerHTML = `
                    <tr><td colspan="8" style="text-align: center;">Kh√¥ng c√≥ ƒë∆°n h√†ng</td></tr>
                `;
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            document.getElementById('orders-table').innerHTML = paginatedOrders.map(order => `
                <tr>
                    <td style="text-align: center;"><strong>${order.order_code}</strong></td>
                    <td style="text-align: center;">${order.customer_name}</td>
                    <td style="text-align: center; font-size: 13px;">
                        ${order.customer_phone}<br>
                        ${order.customer_email ? `${order.customer_email}` : ''}
                    </td>
                    <td style="text-align: center;"><strong>${formatCurrency(order.total_amount)}</strong></td>
                    <td style="text-align: center;">
                        <select class="form-select" style="min-width: 130px;" onchange="updatePaymentStatus(${order.order_id}, this.value)">
                            <option value="unpaid" ${order.payment_status === 'unpaid' ? 'selected' : ''}>Ch∆∞a thanh to√°n</option>
                            <option value="paid" ${order.payment_status === 'paid' ? 'selected' : ''}>ƒê√£ thanh to√°n</option>
                            <option value="refunded" ${order.payment_status === 'refunded' ? 'selected' : ''}>ƒê√£ ho√†n ti·ªÅn</option>
                        </select>
                    </td>
                    <td style="text-align: center;">
                        <select class="form-select" style="min-width: 130px;" onchange="updateStatus(${order.order_id}, this.value)">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Ch·ªù x·ª≠ l√Ω</option>
                            <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Ho√†n th√†nh</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>ƒê√£ h·ªßy</option>
                        </select>
                    </td>
                    <td style="text-align: center;"><small>${formatDate(order.created_at)}</small></td>
                    <td style="text-align: center;">
                        <button class="btn btn-primary btn-sm" onclick="viewOrderDetail(${order.order_id})" style="margin-right: 5px;">Chi ti·∫øt</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteOrder(${order.order_id})">X√≥a</button>
                    </td>
                </tr>
            `).join('');

            renderPagination(orders.length);
        }

        function renderPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);

            let paginationHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                    <button class="btn btn-secondary btn-sm" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                        ‚Üê Trang tr∆∞·ªõc
                    </button>
                    <span style="font-size: 14px;">
                        Hi·ªÉn th·ªã ${startItem}-${endItem} trong t·ªïng ${totalItems} ƒë∆°n h√†ng | Trang ${currentPage}/${totalPages}
                    </span>
                    <button class="btn btn-secondary btn-sm" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                        Trang sau ‚Üí
                    </button>
                </div>
            `;

            document.getElementById('pagination').innerHTML = paginationHTML;
        }

        function changePage(page) {
            const totalPages = Math.ceil(allOrders.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            displayOrders(allOrders);
        }

        async function updateStatus(orderId, newStatus) {
            const confirmed = await showConfirm('B·∫°n c√≥ ch·∫Øc mu·ªën c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng?', 'C·∫≠p nh·∫≠t tr·∫°ng th√°i');
            if (!confirmed) {
                loadOrders();
                return;
            }

            try {
                const result = await AdminAPI.updateOrderStatus(orderId, { status: newStatus });
                
                if (result.success) {
                    showNotification('ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i', 'success');
                } else {
                    showNotification('L·ªói khi c·∫≠p nh·∫≠t', 'error');
                    loadOrders();
                }
            } catch (error) {
                console.error('Update status error:', error);
                showNotification('L·ªói khi c·∫≠p nh·∫≠t', 'error');
                loadOrders();
            }
        }

        async function updatePaymentStatus(orderId, newPaymentStatus) {
            const confirmed = await showConfirm('B·∫°n c√≥ ch·∫Øc mu·ªën c·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n?', 'C·∫≠p nh·∫≠t thanh to√°n');
            if (!confirmed) {
                loadOrders();
                return;
            }

            try {
                const result = await AdminAPI.updateOrderStatus(orderId, { payment_status: newPaymentStatus });
                
                if (result.success) {
                    showNotification('ƒê√£ c·∫≠p nh·∫≠t thanh to√°n', 'success');
                    loadOrders();
                } else {
                    showNotification('L·ªói khi c·∫≠p nh·∫≠t', 'error');
                    loadOrders();
                }
            } catch (error) {
                console.error('Update payment status error:', error);
                showNotification('L·ªói khi c·∫≠p nh·∫≠t', 'error');
                loadOrders();
            }
        }

        async function viewOrderDetail(orderId) {
            try {
                const result = await AdminAPI.getOrderById(orderId);
                
                if (!result.success || !result.data) {
                    showNotification('Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng', 'error');
                    return;
                }

                const order = result.data;
                const items = order.items || [];

                // T·∫°o b·∫£ng s·∫£n ph·∫©m
                const itemsTable = items.length > 0 ? `
                    <table class="admin-table" style="margin-top: 20px;">
                        <thead>
                            <tr>
                                <th>S·∫£n ph·∫©m</th>
                                <th style="text-align: center;">S·ªë l∆∞·ª£ng</th>
                                <th style="text-align: right;">Gi√° nh·∫≠p</th>
                                <th style="text-align: right;">Gi√° b√°n</th>
                                <th style="text-align: right;">Th√†nh ti·ªÅn</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(item => `
                                <tr>
                                    <td><strong>${item.product_name}</strong></td>
                                    <td style="text-align: center;">${item.quantity}</td>
                                    <td style="text-align: right; color: #28a745;">${formatCurrency(item.cost_price || 0)}</td>
                                    <td style="text-align: right; color: #667eea;">${formatCurrency(item.price)}</td>
                                    <td style="text-align: right;"><strong>${formatCurrency(item.subtotal)}</strong></td>
                                </tr>
                            `).join('')}
                            <tr style="border-top: 2px solid #667eea;">
                                <td colspan="4" style="text-align: right; font-weight: bold; font-size: 16px; padding: 15px;">T·ªïng c·ªông:</td>
                                <td style="text-align: right; font-weight: bold; font-size: 18px; color: #667eea; padding: 15px;">${formatCurrency(order.total_amount)}</td>
                            </tr>
                        </tbody>
                    </table>
                ` : '<p style="color: #dc3545; margin-top: 15px;">Kh√¥ng c√≥ s·∫£n ph·∫©m trong ƒë∆°n h√†ng n√†y</p>';

                document.getElementById('order-detail-content').innerHTML = `
                    <h2 style="color: #1e3c72; margin-bottom: 25px; border-bottom: 3px solid #667eea; padding-bottom: 10px;">Chi Ti·∫øt ƒê∆°n H√†ng</h2>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <p style="margin: 8px 0;"><strong style="color: #495057;">M√£ ƒë∆°n h√†ng:</strong> <span style="color: #667eea; font-weight: 600;">${order.order_code}</span></p>
                                <p style="margin: 8px 0;"><strong style="color: #495057;">Kh√°ch h√†ng:</strong> ${order.customer_name}</p>
                                <p style="margin: 8px 0;"><strong style="color: #495057;">S·ªë ƒëi·ªán tho·∫°i:</strong> ${order.customer_phone}</p>
                                <p style="margin: 8px 0;"><strong style="color: #495057;">Email:</strong> ${order.customer_email || 'N/A'}</p>
                            </div>
                            <div>
                                <p style="margin: 8px 0;"><strong style="color: #495057;">Tr·∫°ng th√°i:</strong> ${getStatusBadge(order.status)}</p>
                                <p style="margin: 8px 0;"><strong style="color: #495057;">Thanh to√°n:</strong> ${getPaymentStatusText(order.payment_status)}</p>
                                <p style="margin: 8px 0;"><strong style="color: #495057;">Ng√†y ƒë·∫∑t:</strong> ${new Date(order.created_at).toLocaleString('vi-VN')}</p>
                                <p style="margin: 8px 0;"><strong style="color: #495057;">Ghi ch√∫:</strong> ${order.notes || 'Kh√¥ng c√≥'}</p>
                            </div>
                        </div>
                    </div>

                    <h3 style="color: #1e3c72; margin: 25px 0 15px 0;">Danh S√°ch S·∫£n Ph·∫©m</h3>
                    ${itemsTable}
                `;
                
                document.getElementById('order-modal').style.display = 'flex';
            } catch (error) {
                console.error('View order error:', error);
                showNotification('L·ªói khi xem chi ti·∫øt', 'error');
            }
        }

        function closeModal() {
            document.getElementById('order-modal').style.display = 'none';
        }

        function resetFilters() {
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-payment-status').value = '';
            document.getElementById('search-order-code').value = '';
            currentPage = 1;
            loadOrders();
        }

        function getStatusBadge(status) {
            const badges = {
                'pending': '<span style="background: #ffc107; color: white; padding: 4px 12px; border-radius: 12px;">Ch·ªù x·ª≠ l√Ω</span>',
                'completed': '<span style="background: #28a745; color: white; padding: 4px 12px; border-radius: 12px;">Ho√†n th√†nh</span>',
                'cancelled': '<span style="background: #dc3545; color: white; padding: 4px 12px; border-radius: 12px;">ƒê√£ h·ªßy</span>'
            };
            return badges[status] || status;
        }

        function getPaymentStatusText(status) {
            const texts = {
                'unpaid': '‚è≥ Ch∆∞a thanh to√°n',
                'paid': '‚úÖ ƒê√£ thanh to√°n',
                'refunded': '‚Ü©Ô∏è ƒê√£ ho√†n ti·ªÅn'
            };
            return texts[status] || status;
        }

        async function deleteOrder(orderId) {
            const confirmed = await showConfirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë∆°n h√†ng n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!', 'X√≥a ƒë∆°n h√†ng');
            if (!confirmed) return;

            try {
                const result = await AdminAPI.deleteOrder(orderId);
                
                if (result.success) {
                    showNotification('ƒê√£ x√≥a ƒë∆°n h√†ng th√†nh c√¥ng', 'success');
                    loadOrders();
                } else {
                    showNotification(result.message || 'L·ªói khi x√≥a ƒë∆°n h√†ng', 'error');
                }
            } catch (error) {
                console.error('Delete order error:', error);
                showNotification('L·ªói khi x√≥a ƒë∆°n h√†ng', 'error');
            }
        }

        // Export to Excel function
        async function exportToExcel() {
            try {
                showNotification('ƒêang chu·∫©n b·ªã file Excel...', 'info');
                
                // L·∫•y t·∫•t c·∫£ ƒë∆°n h√†ng v·ªõi chi ti·∫øt
                const result = await AdminAPI.getAllOrders({ limit: 10000 });
                
                if (!result.success || !result.data || result.data.length === 0) {
                    showNotification('Kh√¥ng c√≥ ƒë∆°n h√†ng ƒë·ªÉ xu·∫•t', 'error');
                    return;
                }

                const orders = result.data;
                
                // T·∫°o m·∫£ng d·ªØ li·ªáu cho Excel
                const excelData = [];
                
                // Duy·ªát qua t·ª´ng ƒë∆°n h√†ng v√† l·∫•y chi ti·∫øt
                for (const order of orders) {
                    try {
                        const detailResult = await AdminAPI.getOrderById(order.order_id);
                        
                        if (detailResult.success && detailResult.data) {
                            const orderDetail = detailResult.data;
                            const items = orderDetail.items || [];
                            
                            // Th√™m t·ª´ng s·∫£n ph·∫©m v√†o Excel
                            items.forEach(item => {
                                excelData.push({
                                    'M√£ ƒë∆°n h√†ng': order.order_code,
                                    'Ng√†y ƒë·∫∑t': new Date(order.created_at).toLocaleString('vi-VN'),
                                    'Kh√°ch h√†ng': order.customer_name,
                                    'S·ªë ƒëi·ªán tho·∫°i': order.customer_phone,
                                    'Email': order.customer_email || '',
                                    'S·∫£n ph·∫©m': item.product_name,
                                    'S·ªë l∆∞·ª£ng': item.quantity,
                                    'Gi√° nh·∫≠p (VNƒê)': item.cost_price || 0,
                                    'Gi√° b√°n (VNƒê)': item.price,
                                    'Th√†nh ti·ªÅn (VNƒê)': item.subtotal,
                                    'L·ª£i nhu·∫≠n (VNƒê)': (item.price - (item.cost_price || 0)) * item.quantity,
                                    'T·ªïng ƒë∆°n h√†ng (VNƒê)': order.total_amount,
                                    'Tr·∫°ng th√°i': order.status === 'pending' ? 'Ch·ªù x·ª≠ l√Ω' : order.status === 'completed' ? 'Ho√†n th√†nh' : 'ƒê√£ h·ªßy',
                                    'Thanh to√°n': order.payment_status === 'unpaid' ? 'Ch∆∞a thanh to√°n' : order.payment_status === 'paid' ? 'ƒê√£ thanh to√°n' : 'ƒê√£ ho√†n ti·ªÅn',
                                    'Ghi ch√∫': order.notes || ''
                                });
                            });
                        }
                    } catch (detailError) {
                        console.error(`Error loading detail for order ${order.order_id}:`, detailError);
                    }
                }

                // T·∫°o workbook v√† worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);

                // ƒê·ªãnh d·∫°ng c·ªôt
                const colWidths = [
                    { wch: 15 },  // M√£ ƒë∆°n h√†ng
                    { wch: 18 },  // Ng√†y ƒë·∫∑t
                    { wch: 20 },  // Kh√°ch h√†ng
                    { wch: 15 },  // S·ªë ƒëi·ªán tho·∫°i
                    { wch: 25 },  // Email
                    { wch: 30 },  // S·∫£n ph·∫©m
                    { wch: 10 },  // S·ªë l∆∞·ª£ng
                    { wch: 15 },  // Gi√° nh·∫≠p
                    { wch: 15 },  // Gi√° b√°n
                    { wch: 15 },  // Th√†nh ti·ªÅn
                    { wch: 15 },  // L·ª£i nhu·∫≠n
                    { wch: 18 },  // T·ªïng ƒë∆°n h√†ng
                    { wch: 15 },  // Tr·∫°ng th√°i
                    { wch: 15 },  // Thanh to√°n
                    { wch: 30 }   // Ghi ch√∫
                ];
                ws['!cols'] = colWidths;

                // Th√™m worksheet v√†o workbook
                XLSX.utils.book_append_sheet(wb, ws, 'ƒê∆°n h√†ng');

                // T·∫°o t√™n file v·ªõi timestamp
                const timestamp = new Date().toISOString().slice(0, 10);
                const filename = `DonHang_${timestamp}.xlsx`;

                // Download file
                XLSX.writeFile(wb, filename);
                
                showNotification(`‚úÖ ƒê√£ xu·∫•t ${excelData.length} d√≤ng d·ªØ li·ªáu ra file ${filename}`, 'success');
            } catch (error) {
                console.error('Export Excel error:', error);
                showNotification('L·ªói khi xu·∫•t Excel: ' + error.message, 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Request notification permission
            requestNotificationPermission();
            
            loadOrders();
            startAutoRefresh();
            
            console.log('üì° Auto-refresh enabled: checking for new orders every 30 seconds');
            
            // Stop auto-refresh when user leaves page
            window.addEventListener('beforeunload', stopAutoRefresh);
        });
    </script>

    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            cursor: pointer;
        }
    </style>

    <script src="/admin/js/notifications.js"></script>
    <script src="/admin/js/admin.js"></script>
</body>
</html>
