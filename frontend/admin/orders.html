<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω ƒë∆°n h√†ng - Admin</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/admin/css/admin.css">
</head>
<body>
    <div class="admin-layout">
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <span class="logo-icon">üéÆ</span>
                <span>GameShop Admin</span>
            </div>
            
            <nav class="admin-nav">
                <a href="/admin/dashboard.html" class="nav-item">
                    <span>üìä</span> Dashboard
                </a>
                <a href="/admin/orders.html" class="nav-item active">
                    <span>üõí</span> ƒê∆°n h√†ng
                </a>
                <a href="/admin/products.html" class="nav-item">
                    <span>üì¶</span> S·∫£n ph·∫©m
                </a>
                <a href="/admin/games.html" class="nav-item">
                    <span>üéÆ</span> Games
                </a>
                <a href="/admin/contacts.html" class="nav-item">
                    <span>üìß</span> Li√™n h·ªá
                </a>
                <a href="#" onclick="logout()" class="nav-item">
                    <span>üö™</span> ƒêƒÉng xu·∫•t
                </a>
            </nav>
        </aside>

        <main class="admin-content">
            <header class="admin-header">
                <h1>Qu·∫£n L√Ω ƒê∆°n H√†ng</h1>
            </header>

            <div class="dashboard-section">
                <div class="filter-bar">
                    <select id="filter-status" class="form-select">
                        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                        <option value="pending">Ch·ªù x·ª≠ l√Ω</option>
                        <option value="processing">ƒêang x·ª≠ l√Ω</option>
                        <option value="completed">Ho√†n th√†nh</option>
                        <option value="cancelled">ƒê√£ h·ªßy</option>
                    </select>

                    <button class="btn btn-primary" onclick="loadOrders()">L·ªçc</button>
                    <button class="btn btn-secondary" onclick="resetFilters()">X√≥a b·ªô l·ªçc</button>
                </div>

                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>M√£ ƒë∆°n</th>
                                <th>Kh√°ch h√†ng</th>
                                <th>Li√™n h·ªá</th>
                                <th>T·ªïng ti·ªÅn</th>
                                <th>Thanh to√°n</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Ng√†y ƒë·∫∑t</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table">
                            <tr>
                                <td colspan="8" style="text-align: center;">ƒêang t·∫£i...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Order Detail Modal -->
    <div id="order-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div id="order-detail-content"></div>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script src="/admin/js/admin.js"></script>
    <script>
        async function loadOrders() {
            const auth = checkAdminAuth();
            if (!auth) return;

            const status = document.getElementById('filter-status').value;
            const params = status ? { status } : {};

            try {
                const result = await AdminAPI.getAllOrders(params);
                
                if (!result.success || !result.data || result.data.length === 0) {
                    document.getElementById('orders-table').innerHTML = `
                        <tr><td colspan="8" style="text-align: center;">Kh√¥ng c√≥ ƒë∆°n h√†ng</td></tr>
                    `;
                    return;
                }

                displayOrders(result.data);
            } catch (error) {
                console.error('Load orders error:', error);
                showNotification('L·ªói khi t·∫£i ƒë∆°n h√†ng', 'error');
            }
        }

        function displayOrders(orders) {
            document.getElementById('orders-table').innerHTML = orders.map(order => `
                <tr>
                    <td><strong>${order.order_code}</strong></td>
                    <td>${order.buyer_name}</td>
                    <td>
                        üìû ${order.buyer_phone}<br>
                        ${order.buyer_email ? `üìß ${order.buyer_email}` : ''}
                    </td>
                    <td><strong>${formatCurrency(order.total_amount)}</strong></td>
                    <td>
                        ${order.payment_method === 'bank_transfer' ? 'üè¶' : 'üí∞'}<br>
                        <small>${getPaymentStatusText(order.payment_status)}</small>
                    </td>
                    <td>
                        <select class="form-select" style="min-width: 130px;" onchange="updateStatus(${order.id}, this.value)">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Ch·ªù x·ª≠ l√Ω</option>
                            <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>ƒêang x·ª≠ l√Ω</option>
                            <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Ho√†n th√†nh</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>ƒê√£ h·ªßy</option>
                        </select>
                    </td>
                    <td><small>${formatDate(order.created_at)}</small></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewOrderDetail(${order.id})">Chi ti·∫øt</button>
                    </td>
                </tr>
            `).join('');
        }

        async function updateStatus(orderId, newStatus) {
            if (!confirm('C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng?')) {
                loadOrders();
                return;
            }

            try {
                const result = await AdminAPI.updateOrderStatus(orderId, { status: newStatus });
                
                if (result.success) {
                    showNotification('ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i', 'success');
                } else {
                    showNotification('L·ªói khi c·∫≠p nh·∫≠t', 'error');
                    loadOrders();
                }
            } catch (error) {
                console.error('Update status error:', error);
                showNotification('L·ªói khi c·∫≠p nh·∫≠t', 'error');
                loadOrders();
            }
        }

        async function viewOrderDetail(orderId) {
            try {
                const result = await AdminAPI.getAllOrders();
                const order = result.data.find(o => o.id === orderId);
                
                if (!order) {
                    showNotification('Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng', 'error');
                    return;
                }

                document.getElementById('order-detail-content').innerHTML = `
                    <h2>Chi Ti·∫øt ƒê∆°n H√†ng</h2>
                    <div style="margin: 20px 0;">
                        <p><strong>M√£ ƒë∆°n:</strong> ${order.order_code}</p>
                        <p><strong>Kh√°ch h√†ng:</strong> ${order.buyer_name}</p>
                        <p><strong>SƒêT:</strong> ${order.buyer_phone}</p>
                        <p><strong>Email:</strong> ${order.buyer_email || 'N/A'}</p>
                        <p><strong>Nickname game:</strong> ${order.game_nickname || 'N/A'}</p>
                        <p><strong>Server:</strong> ${order.game_server || 'N/A'}</p>
                        <p><strong>T·ªïng ti·ªÅn:</strong> <span style="color: var(--primary-color); font-size: 20px;">${formatCurrency(order.total_amount)}</span></p>
                        <p><strong>Ghi ch√∫:</strong> ${order.note || 'Kh√¥ng c√≥'}</p>
                    </div>
                `;
                
                document.getElementById('order-modal').style.display = 'flex';
            } catch (error) {
                console.error('View order error:', error);
                showNotification('L·ªói khi xem chi ti·∫øt', 'error');
            }
        }

        function closeModal() {
            document.getElementById('order-modal').style.display = 'none';
        }

        function resetFilters() {
            document.getElementById('filter-status').value = '';
            loadOrders();
        }

        document.addEventListener('DOMContentLoaded', loadOrders);
    </script>

    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            cursor: pointer;
        }
    </style>
</body>
</html>
