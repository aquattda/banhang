<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Shop - Mua v·∫≠t ph·∫©m game nhanh, an to√†n, uy t√≠n</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/home.css">
    <link rel="stylesheet" href="/css/modern-layout.css">
</head>
<body>
    <!-- Header -->
    <header class="modern-header">
        <div class="container">
            <div class="header-content">
                <!-- Logo -->
                <a href="/" class="header-logo">
                    <img src="/images/logo/roblox-app-icon-hd-removebg-preview.png" alt="Solo Shop Logo">
                    <span>Minalo Shop</span>
                </a>
                
                <!-- Search Bar -->
                <div class="header-search">
                    <input type="text" placeholder="T√¨m s·∫£n ph·∫©m, d·ªãch v·ª•..." id="search-input">
                    <button class="search-btn">üîç</button>
                </div>
                
                <!-- Navigation Actions -->
                <div class="header-actions">
                    <a href="/contact.html" class="header-link">
                        <span class="icon">üí¨</span>
                        <span>H·ªó tr·ª£</span>
                    </a>
                    <a href="/orders.html" class="header-link">
                        <span class="icon">üìã</span>
                        <span>L·ªãch s·ª≠</span>
                    </a>
                    <a href="/recharge.html" class="header-btn btn-recharge">
                        <span class="icon">üí≥</span>
                        <span>N·∫°p ti·ªÅn</span>
                    </a>
                    <div id="auth-btn-modern"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Hero Section with Video & Banners -->
        <section class="hero-modern">
            <div class="container">
                <div class="hero-grid">
                    <!-- Left: Video -->
                    <div class="hero-video-section">
                        <div class="video-wrapper">
                            <iframe id="hero-video" src="https://www.youtube.com/embed/dQw4w9WgXcQ?enablejsapi=1" 
                                    title="Video gi·ªõi thi·ªáu" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen>
                            </iframe>
                        </div>
                    </div>
                
                    <!-- Right: Banners & Info -->
                    <div class="hero-banners-section">
                        <div class="banner-item banner-primary">
                            <img src="/images/banner/Roblox_poster__63237.jpg" alt="Banner ∆∞u ƒë√£i ƒë·∫∑c bi·ªát">
                            <div class="banner-overlay">
                                <h3>üéÅ ∆Øu ƒê√£i ƒê·∫∑c Bi·ªát</h3>
                                <p>Nh·∫≠n ngay khuy·∫øn m√£i h·∫•p d·∫´n</p>
                            </div>
                        </div>
                        <div class="banner-item banner-secondary">
                            <img src="/images/banner/Roblox_poster__63237.jpg" alt="Banner s·ª± ki·ªán m·ªõi">
                            <div class="banner-overlay">
                                <h3>üéÆ S·ª± Ki·ªán Hot</h3>
                                <p>C·∫≠p nh·∫≠t game m·ªõi nh·∫•t</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    
        <!-- Roblox Categories Section -->
        <section class="roblox-categories-section">
            <div class="container">
                <div class="roblox-categories-grid" id="roblox-categories">
                    <div style="text-align: center; padding: 40px 20px;">
                        <div class="loading-spinner">‚è≥ ƒêang t·∫£i...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- All Games Categories Section -->
        <section class="all-games-section">
            <div class="container">
                <div class="games-categories-grid" id="all-games-categories">
                    <!-- All game categories will be loaded here -->
                    <div style="text-align: center; padding: 60px 20px;">
                        <div class="loading-spinner">‚è≥ ƒêang t·∫£i danh m·ª•c...</div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3><img src="/images/logo/roblox-app-icon-hd-removebg-preview.png" alt="GameShop" style="height: 30px; vertical-align: middle;"> GameShop</h3>
                    <p>N·ªÅn t·∫£ng mua v·∫≠t ph·∫©m game uy t√≠n, nhanh ch√≥ng v√† an to√†n nh·∫•t Vi·ªát Nam.</p>
                    <div class="social-links">
                        <a href="https://www.facebook.com/tuan.474" title="Facebook" target="_blank">üìò</a>
                        <a href="https://zalo.me/0363296105" title="Zalo" target="_blank">üí¨</a>
                        <a href="mailto:aquattda@gmail.com" title="Email" target="_blank">üìß</a>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h3>Li√™n H·ªá</h3>
                    <p>üìû Hotline: 0363296105</p>
                    <p>üìß Email: aquattda@gmail.com</p>
                    <p>üí¨ Zalo: 0363296105</p>
                    <p>üïê H·ªó tr·ª£: 8:00 - 22:00 h√†ng ng√†y</p>
                </div>
                
                <div class="footer-section">
                    <h3>Ch√≠nh S√°ch</h3>
                    <a href="#">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a>
                    <a href="#">Ch√≠nh s√°ch b·∫£o m·∫≠t</a>
                    <a href="#">H∆∞·ªõng d·∫´n mua h√†ng</a>
                    <a href="#">C√¢u h·ªèi th∆∞·ªùng g·∫∑p</a>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>‚ö†Ô∏è L∆∞u √Ω: Trang web kh√¥ng thu·ªôc s·ªü h·ªØu c·ªßa Roblox, Garena, hay b·∫•t k·ª≥ nh√† ph√°t tri·ªÉn game n√†o. Ch√∫ng t√¥i ch·ªâ cung c·∫•p d·ªãch v·ª• n·∫°p v·∫≠t ph·∫©m h·ª£p l·ªá.</p>
                <p>&copy; 2025 GameShop. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="/js/app.js"></script>
    <script src="/js/customer-auth.js"></script>
    <script>
        // Load Roblox Services
        async function loadRobloxServices() {
            try {
                // Get Roblox game categories (assuming Roblox games have IDs 1-11)
                // Let's try game_id = 1 (BloxFruits) for the service section
                const result = await API.getCategoriesByGame(1);
                
                if (result.success && result.data.length > 0) {
                    const servicesContainer = document.getElementById('roblox-services');
                    servicesContainer.innerHTML = result.data.map(category => `
                        <div class="service-card" onclick="navigateTo('/product.html?game_id=1&category_id=${category.category_id}')">
                            <div class="service-icon">
                                ${category.icon ? `<span style="font-size: 48px;">${category.icon}</span>` : 'üéÆ'}
                            </div>
                            <h3 class="service-name">${category.name}</h3>
                        </div>
                    `).join('');
                } else {
                    console.log('No categories found for Roblox services');
                }
            } catch (error) {
                console.error('Error loading Roblox services:', error);
            }
        }
        
        // Load Roblox Categories (Actually displaying GAMES, not categories)
        async function loadRobloxCategories() {
            try {
                const container = document.getElementById('roblox-categories');
                
                // Get all games
                const gamesResult = await API.getGames();
                
                if (!gamesResult.success || !gamesResult.data) {
                    container.innerHTML = '<p style="text-align:center;color:#999;">ƒêang c·∫≠p nh·∫≠t...</p>';
                    return;
                }
                
                // Filter Roblox games (exclude non-Roblox if needed)
                const robloxGames = gamesResult.data.filter(game => 
                    game.name !== 'Li√™n Qu√¢n Mobile' && game.game_id !== 12
                );
                
                if (robloxGames.length === 0) {
                    container.innerHTML = '<p style="text-align:center;color:#999;">Ch∆∞a c√≥ game n√†o</p>';
                    return;
                }
                
                // Game icons mapping
                const gameIcons = {
                    'bloxfruits': 'üçá',
                    'king-legacy': 'üëë',
                    'strongest-battlegrounds': 'üí™',
                    'code-roblox': 'üéÆ',
                    'sols-rng': 'üé∞',
                    'heroes-battlegrounds': 'ü¶∏',
                    'rivals': 'üî´',
                    'jujutsu-shenanigans': '‚ö°',
                    'blue-lock-rivals': '‚öΩ',
                    'forsaken': 'üó°Ô∏è',
                    'fish-it': 'üêü'
                };
                
                // Display only first 5 games + "Xem Th√™m" button
                const displayGames = robloxGames.slice(0, 5);
                
                container.innerHTML = displayGames.map(game => `
                    <div class="category-box" onclick="window.location.href='/games.html?game_id=${game.game_id}'">
                        <div class="category-box-image">
                            ${gameIcons[game.slug] || 'üéÆ'}
                        </div>
                        <div class="category-box-name">${game.name}</div>
                    </div>
                `).join('') + `
                    <div class="category-box category-box-more" onclick="window.location.href='/games.html'">
                        <div class="category-box-image">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </div>
                        <div class="category-box-name">Xem Th√™m</div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading Roblox games:', error);
                document.getElementById('roblox-categories').innerHTML = '<p style="text-align:center;color:#ff6b6b;">L·ªói khi t·∫£i danh s√°ch game</p>';
            }
        }

        
        // Load Product Sections
        async function loadAllGamesCategories() {
            try {
                const container = document.getElementById('all-games-categories');
                
                // Define sections v·ªõi category_id v√† game_id c·ª• th·ªÉ
                const sections = [
                    { 
                        title: 'Tr√°i √Åc Qu·ª∑', 
                        icon: 'üçá', 
                        game_id: 1, 
                        category_id: 1,
                        categoryName: 'Tr√°i'
                    },
                    { 
                        title: 'V·∫≠t Ph·∫©m Blox Fruit', 
                        icon: 'üó°Ô∏è', 
                        game_id: 1, 
                        category_id: 2,
                        categoryName: 'Gamepass'
                    },
                    { 
                        title: 'Units', 
                        icon: 'ü§ñ', 
                        game_id: 3, 
                        category_id: 3,
                        categoryName: 'Units'
                    },
                    { 
                        title: 'V·∫≠t Ph·∫©m King Legacy', 
                        icon: 'üè¥‚Äç‚ò†Ô∏è', 
                        game_id: 2, 
                        category_id: 4,
                        categoryName: 'Items'
                    }
                ];
                
                let htmlContent = '';
                
                // Load products for each section
                for (const section of sections) {
                    try {
                        // Get products by game_id and category_id
                        const productsResult = await API.getProducts({
                            game_id: section.game_id,
                            category_id: section.category_id
                        });
                        
                        console.log(`Products for ${section.title}:`, productsResult);
                        
                        if (productsResult.success && productsResult.data && productsResult.data.length > 0) {
                            // Limit to 15 products per section for horizontal scroll
                            const displayProducts = productsResult.data.slice(0, 15);
                            
                            htmlContent += `
                                <div class="game-category-section">
                                    <div class="game-category-header">
                                        <div class="game-category-header-left">
                                            <div class="category-icon">${section.icon}</div>
                                            <div class="category-info">
                                                <h2>${section.title}</h2>
                                            </div>
                                        </div>
                                        <a href="/product.html?game_id=${section.game_id}&category_id=${section.category_id}" class="view-more-btn">Xem Th√™m</a>
                                    </div>
                                    <div class="category-carousel-wrapper">
                                        <button class="carousel-nav-btn prev-btn" onclick="event.stopPropagation(); scrollCarousel(this, -1)">‚Äπ</button>
                                        <div class="category-items-carousel">
                                        ${displayProducts.map(product => `
                                            <div class="category-item-card" onclick="window.location.href='/product.html?id=${product.product_id}'">
                                                <div class="category-item-icon">
                                                    ${product.image_url ? `<img src="${product.image_url}" alt="${product.name}">` : 'üéÆ'}
                                                </div>
                                                <h3 class="category-item-name">${product.name}</h3>
                                                <div class="category-item-price">${product.price ? product.price.toLocaleString('vi-VN') + 'ƒë' : 'Li√™n h·ªá'}</div>
                                                <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); addToCartAndRedirect(${product.product_id}, '${product.name.replace(/'/g, "\\'")}'  , ${product.price || 0}, '${product.image_url || ''}')">Mua Ngay</button>
                                            </div>
                                        `).join('')}
                                        </div>
                                        <button class="carousel-nav-btn next-btn" onclick="event.stopPropagation(); scrollCarousel(this, 1)">‚Ä∫</button>
                                    </div>
                                </div>
                            `;
                        } else {
                            console.log(`No products found for ${section.title}`);
                        }
                    } catch (err) {
                        console.error(`Error loading products for ${section.title}:`, err);
                    }
                }
                
                if (htmlContent) {
                    // Add "View All Categories" section at the end
                    htmlContent += `
                        <div class="view-all-categories-section">
                            <a href="/games.html" class="btn-view-all">Xem T·∫•t C·∫£ Danh M·ª•c ‚Üí</a>
                        </div>
                    `;
                    container.innerHTML = htmlContent;
                    
                    // Initialize drag-to-scroll after content is loaded
                    setTimeout(() => initCarouselDragScroll(), 100);
                } else {
                    container.innerHTML = '<p style="text-align:center;padding:40px;color:#999;">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o</p>';
                }
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('all-games-categories').innerHTML = '<p style="text-align:center;padding:40px;color:#ff6b6b;">L·ªói khi t·∫£i s·∫£n ph·∫©m. Vui l√≤ng th·ª≠ l·∫°i sau.</p>';
            }
        }
        
        // Add to cart and redirect to cart page
        function addToCartAndRedirect(productId, productName, productPrice, productImage) {
            // Get existing cart or create new one
            let cart = JSON.parse(localStorage.getItem('cart') || '[]');
            
            // Check if product already exists in cart
            const existingItem = cart.find(item => item.product_id === productId);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    product_id: productId,
                    name: productName,
                    price: productPrice,
                    image_url: productImage,
                    quantity: 1
                });
            }
            
            // Save cart
            localStorage.setItem('cart', JSON.stringify(cart));
            
            // Redirect to cart page
            window.location.href = '/cart.html';
        }

        // Carousel Navigation Function
        function scrollCarousel(button, direction) {
            const carousel = button.parentElement.querySelector('.category-items-carousel');
            const cardWidth = carousel.querySelector('.category-item-card').offsetWidth;
            const gap = 20; // gap between cards
            const scrollAmount = (cardWidth + gap) * 3; // Scroll 3 cards at a time
            
            carousel.scrollBy({
                left: direction * scrollAmount,
                behavior: 'smooth'
            });
        }

        // Initialize drag-to-scroll for all carousels
        function initCarouselDragScroll() {
            const carousels = document.querySelectorAll('.category-items-carousel');
            
            carousels.forEach(carousel => {
                let isDown = false;
                let startX;
                let scrollLeft;
                let hasMoved = false;

                carousel.addEventListener('mousedown', (e) => {
                    // Don't interfere with clicks on buttons
                    if (e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
                    
                    isDown = true;
                    hasMoved = false;
                    startX = e.pageX - carousel.offsetLeft;
                    scrollLeft = carousel.scrollLeft;
                    carousel.style.cursor = 'grabbing';
                });

                carousel.addEventListener('mouseleave', () => {
                    isDown = false;
                    carousel.classList.remove('active-drag');
                    carousel.style.cursor = 'grab';
                });

                carousel.addEventListener('mouseup', () => {
                    isDown = false;
                    carousel.classList.remove('active-drag');
                    carousel.style.cursor = 'grab';
                });

                carousel.addEventListener('mousemove', (e) => {
                    if (!isDown) return;
                    e.preventDefault();
                    
                    const x = e.pageX - carousel.offsetLeft;
                    const walk = (x - startX) * 2; // Scroll speed multiplier
                    
                    // If moved more than 5px, consider it a drag
                    if (Math.abs(walk) > 5) {
                        hasMoved = true;
                        carousel.classList.add('active-drag');
                    }
                    
                    carousel.scrollLeft = scrollLeft - walk;
                });

                // Prevent click event when dragging
                carousel.addEventListener('click', (e) => {
                    if (hasMoved) {
                        e.preventDefault();
                        e.stopPropagation();
                        hasMoved = false;
                    }
                }, true);
            });
        }

        // Load wallet balance
        async function loadWalletBalance() {
            try {
                const token = localStorage.getItem('customer_token');
                if (!token) return 0;
                
                const response = await fetch('http://localhost:3000/api/recharge/wallet', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.balance || 0;
                }
                return 0;
            } catch (error) {
                console.error('Load wallet error:', error);
                return 0;
            }
        }
        
        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' ‚Ç´';
        }
        
        // Modern Auth Button
        function updateModernAuthButton() {
            const authBtn = document.getElementById('auth-btn-modern');
            if (!authBtn) return;
            
            if (CustomerAuth && CustomerAuth.isLoggedIn()) {
                const customer = CustomerAuth.getCustomer();
                
                // Load wallet balance
                loadWalletBalance().then(balance => {
                    authBtn.innerHTML = `
                        <div class="user-menu-modern">
                            <button class="header-btn btn-login" onclick="toggleUserDropdown()">
                                <span class="icon">üë§</span>
                                <span>${customer.name || customer.email}</span>
                            </button>
                            <div class="user-dropdown-modern" id="user-dropdown-modern">
                                <div style="padding: 10px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px 8px 0 0; margin: -8px -8px 8px -8px;">
                                    <div style="font-size: 12px; opacity: 0.9;">S·ªë d∆∞ v√≠</div>
                                    <div style="font-size: 18px; font-weight: bold;">${formatCurrency(balance)}</div>
                                </div>
                                <a href="/account.html">T√†i kho·∫£n</a>
                                <a href="/orders.html">ƒê∆°n h√†ng</a>
                                <a href="/recharge.html" style="color: #667eea; font-weight: 600;">üí≥ N·∫°p ti·ªÅn</a>
                                <a href="/wallet-history.html">üìú L·ªãch s·ª≠ n·∫°p ti·ªÅn</a>
                                <a href="#" onclick="CustomerAuth.logout(); return false;">ƒêƒÉng xu·∫•t</a>
                            </div>
                        </div>
                    `;
                }).catch(err => {
                    // N·∫øu kh√¥ng load ƒë∆∞·ª£c balance, v·∫´n hi·ªÉn th·ªã menu b√¨nh th∆∞·ªùng
                    authBtn.innerHTML = `
                        <div class="user-menu-modern">
                            <button class="header-btn btn-login" onclick="toggleUserDropdown()">
                                <span class="icon">üë§</span>
                                <span>${customer.name || customer.email}</span>
                            </button>
                            <div class="user-dropdown-modern" id="user-dropdown-modern">
                                <a href="/account.html">T√†i kho·∫£n</a>
                                <a href="/orders.html">ƒê∆°n h√†ng</a>
                                <a href="/recharge.html" style="color: #667eea; font-weight: 600;">üí≥ N·∫°p ti·ªÅn</a>
                                <a href="/wallet-history.html">üìú L·ªãch s·ª≠ n·∫°p ti·ªÅn</a>
                                <a href="#" onclick="CustomerAuth.logout(); return false;">ƒêƒÉng xu·∫•t</a>
                            </div>
                        </div>
                    `;
                });
            } else {
                authBtn.innerHTML = `
                    <a href="/login.html" class="header-btn btn-login">
                        <span class="icon">üîê</span>
                        <span>ƒêƒÉng nh·∫≠p</span>
                    </a>
                `;
            }
        }
        
        function toggleUserDropdown() {
            const dropdown = document.getElementById('user-dropdown-modern');
            if (dropdown) {
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            }
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('user-dropdown-modern');
            const userMenu = document.querySelector('.user-menu-modern');
            if (dropdown && userMenu && !userMenu.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        // Auto-pause video when scrolling away
        const videoIframe = document.getElementById('hero-video');
        const heroSection = document.querySelector('.hero-modern');
        
        window.addEventListener('scroll', function() {
            if (!videoIframe || !heroSection) return;
            
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const sectionBottom = heroSection.offsetTop + heroSection.offsetHeight;
            
            if (scrollTop > sectionBottom - 200) {
                const currentSrc = videoIframe.src;
                if (currentSrc && !currentSrc.includes('autoplay=0')) {
                    videoIframe.src = currentSrc.replace('?enablejsapi=1', '?enablejsapi=1&autoplay=0');
                }
            }
        });
        
        // Search functionality
        document.getElementById('search-input')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const query = this.value.trim();
                if (query) {
                    navigateTo(`/games.html?search=${encodeURIComponent(query)}`);
                }
            }
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, initializing...');
            loadRobloxServices();
            loadRobloxCategories();
            loadAllGamesCategories();
            updateModernAuthButton();
        });
    </script>
</body>
</html>
